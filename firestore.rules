rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function userHasUserData() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userHasFullUserData() {
      let data = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return ("accountType" in data)
             && ("username" in data);
    }
    
    match /users/{targetUid} {
      // There's no sensitive info yet so anyone logged in can read any other account.
      allow read: if request.auth != null;

      // Can only be done by the same user.
      allow create, update: if request.auth != null
                            && targetUid == request.auth.uid
                            && (
                              (!("accountType" in request.resource.data)
                               || (request.resource.data.accountType == "student" || request.resource.data.accountType == "teacher"))
                              && (!("username" in request.resource.data)
                               || !(request.resource.data.username == "" || request.resource.data.username.size() > 72))
                            );

      allow delete: if false; // TODO: implement account deletion
    }

    match /courses/{targetCourseId} {
      function isTeacher() {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return userData.accountType == "teacher";
      }

      function isIncludedInTeachers() {
        let courseData = resource.data;
        return ("teachers" in courseData)
               && (request.auth.uid in courseData.teachers);
      }

      allow read: if request.auth != null
                  && userHasUserData()
                  && userHasFullUserData()
                  && (request.auth.uid in resource.data.teachers);

      allow create: if request.auth != null
                    && userHasUserData()
                    && userHasFullUserData()
                    && isTeacher()
                    && "courseCode" in request.resource.data
                    && request.resource.data.courseCode != "" && request.resource.data.courseCode.size() <= 10
                    && "courseName" in request.resource.data
                    && request.resource.data.courseName != "" && request.resource.data.courseName.size() <= 72
                    && "owner" in request.resource.data
                    && request.auth.uid == request.resource.data.owner
                    && "teachers" in request.resource.data
                    && request.resource.data.teachers.size() == 1
                    && request.auth.uid in request.resource.data.teachers;
      allow update: if request.auth != null
                    && userHasUserData()
                    && userHasFullUserData()
                    && isTeacher()
                    && isIncludedInTeachers()
                    && (
                      !("owner" in request.resource.data)
                      || (request.auth.uid == resource.data.owner)
                    );
      allow delete: if request.auth.uid == resource.data.owner;
    }
  }
}
