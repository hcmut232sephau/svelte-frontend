rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Reading user data
    // There's no sensitive info yet so anyone logged in can read any other account.
  	match /users/{targetUid} {
      allow read: if request.auth != null;
    }

    // Writing user data
    // Can only be done by the same user.
    match /users/{targetUid} {
      allow create, update: if request.auth != null
                            && targetUid == request.auth.uid
                            && (
                              (!("accountType" in request.resource.data)
                               || (request.resource.data.accountType == "student" || request.resource.data.accountType == "teacher"))
                              && (!("username" in request.resource.data)
                               || !(request.resource.data.username == "" || request.resource.data.username.length > 72))
                            );

      allow delete: if false; // TODO: implement account deletion
    }

    // Reading courses
    match /courses/{targetCourseId} {
      function checkCourseRead() {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        let courseData = get(/databases/$(database)/documents/courses/$(targetCourseId)).data;
        return ("accountType" in userData)
               && ("teachers" in courseData)
               && (
                 (userData.accountType == "teacher" && request.auth.uid in courseData.teachers)
                 || (userData.accountType == "student" && request.auth.uid in courseData.students)
               );
      }

      allow read: if request.auth != null
                  && checkCourseRead();
    }

    // Writing courses
    // TODO
    match /courses/{targetCourseId} {
      function isTeacher() {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return ("accountType" in userData)
               && (userData.accountType == "teacher");
      }

      function isIncludedTeacher() {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        let courseData = get(/databases/$(database)/documents/courses/$(targetCourseId)).data;
        return ("accountType" in userData)
               && (userData.accountType == "teacher")
               && ("teachers" in courseData)
               && (request.auth.id in courseData.teachers);
      }

      allow create: if request.auth != null
                    && isTeacher()
                    && "courseCode" in request.resource.data
                    && request.resource.data.courseCode != "" && request.resource.data.courseCode.length <= 10
                    && "courseName" in request.resource.data
                    && request.resource.data.courseName != "" && request.resource.data.courseName.length <= 72
                    && "teachers" in request.resource.data
                    && request.resource.data.teachers.length == 1
                    && request.auth.id in request.resource.data.teachers
                    && "students" in request.resource.data
                    && request.resource.data.teachers.length == 0;
      allow update: if request.auth != null
                    && isIncludedTeacher();
    }
  }
}
